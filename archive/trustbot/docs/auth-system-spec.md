# Authentication System Specification
Generated by Aurais Work Loop - 2026-01-16

## Overview
This specification was autonomously generated by the Aurais AgentWorkLoop system using:
- T5-PLANNER for objective decomposition
- T2-WORKER agents for parallel execution
- T5-VALIDATOR for quality assurance

All subtasks achieved 95% confidence with 88-92% validation scores.

---

## 1. User Registration Flow

### Process Steps
1. **Registration Form Submission** - Collect email, password, confirm_password, first_name, last_name
2. **Input Validation** - Server-side validation of all fields
3. **Duplicate Checking** - Case-insensitive email lookup with generic error
4. **Account Creation** - bcrypt hash (salt 12), generate verification token
5. **Email Verification** - 24-hour token expiry
6. **Registration Response** - Success/error feedback

### Validation Rules
| Field | Rules |
|-------|-------|
| Email | Valid format, max 254 chars, lowercase, trimmed |
| Password | 8-128 chars, uppercase + lowercase + number + special |
| Names | 2-50 chars, letters/spaces/hyphens/apostrophes |

### Security Measures
- Rate limiting: 5 registration attempts per IP per hour
- CSRF protection required
- Input sanitization for XSS prevention
- Cryptographically secure verification tokens

### Database Schema
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(254) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email_verified BOOLEAN DEFAULT FALSE,
    verification_token VARCHAR(255),
    token_expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP
);
```

---

## 2. Password Requirements & Hashing

### Password Policy
- **Minimum length**: 12 characters
- **Maximum length**: 128 characters
- **Required characters**: lowercase + uppercase + digit + special
- **Forbidden**: Common passwords, sequential chars, dictionary words

### Hashing Algorithm
**Primary: Argon2id**
```
memory_cost: 64MB (65536 KB)
time_cost: 3 iterations
parallelism: 4 threads
hash_length: 32 bytes
salt_length: 16 bytes
```

**Fallback: bcrypt**
```
cost_factor: 12
salt_rounds: 12
```

### Storage Format
```
$argon2id$v=19$m=65536,t=3,p=4$base64_salt$base64_hash
```

### Implementation Guidelines
- Constant-time comparison for hash verification
- Progressive delays for failed attempts
- Store hash of last 5 passwords to prevent reuse
- Optional 90-day expiration for high-security environments

---

## 3. Login/Logout Process

### Login Flow
1. Form submission (email + password)
2. Rate limiting check
3. Credential verification
4. Session creation
5. Response with redirect

### Rate Limiting
| Scope | Limit |
|-------|-------|
| Per IP | 10 attempts per 15 minutes |
| Per Email | 5 attempts per 15 minutes |

### Progressive Delays
| Attempts | Action |
|----------|--------|
| 1-3 | No delay |
| 4-5 | 2 second delay |
| 6+ | 5 second delay + CAPTCHA |

### Account Lockout
- **Trigger**: 5 failed attempts within 15 minutes
- **Duration**: 30 minutes automatic unlock
- **Notification**: Email alert to user

### Session Cookie Settings
```javascript
{
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
    maxAge: 3600  // 1 hour
}
```

### Logout Procedures
- Invalidate session server-side
- Clear session cookie
- Log logout event
- Redirect to login

### Timeouts
- Session timeout: 1 hour inactivity
- Absolute timeout: 8 hours maximum
- Concurrent sessions: Max 3 per user

---

## 4. Session Management System

### Architecture
**Hybrid JWT + Server-side validation**

### JWT Implementation
- **Algorithm**: RS256 (RSA with SHA-256)
- **Key rotation**: Every 90 days
- **Storage**: HttpOnly, Secure, SameSite cookies

### JWT Payload
```json
{
    "sub": "user_id",
    "session_id": "unique_session_identifier",
    "iat": "issued_at_timestamp",
    "exp": "expiration_timestamp",
    "roles": ["user_roles_array"],
    "jti": "jwt_id_for_blacklisting"
}
```

### Server-Side Storage
- **Primary**: Redis (in-memory cache)
- **Backup**: PostgreSQL sessions table
- **Replication**: Redis cluster with master-slave

### Token Lifetimes
| Token Type | Duration |
|------------|----------|
| Access token | 15 minutes |
| Refresh token | 7 days |
| Remember me | 30 days |
| Idle timeout | 2 hours |

### Hijacking Prevention
- IP address validation
- User agent fingerprinting
- Concurrent session limit (3)
- Geolocation monitoring
- Anomaly detection

### Session Validation Flow
1. Extract JWT from HttpOnly cookie
2. Verify JWT signature and expiration
3. Check session_id exists in Redis
4. Validate IP address and user agent
5. Update last_activity timestamp
6. Return user context

---

## Generation Metadata

- **Generated by**: Aurais AgentWorkLoop v1.0
- **Objective**: "Design a simple user authentication system"
- **Priority**: HIGH
- **Total subtasks**: 7
- **Completion rate**: 100%
- **Average confidence**: 95%
- **Validation scores**: 88-92%
- **Total execution time**: ~2 minutes
