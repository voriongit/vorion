name: Schema Drift Check

on:
  push:
    branches: [master, main]
    paths:
      - 'packages/**/*.ts'
      - 'apps/**/*.ts'
      - 'src/**/*.ts'
      - 'scripts/check-schema-drift.ts'
  pull_request:
    branches: [master, main]
    paths:
      - 'packages/**/*.ts'
      - 'apps/**/*.ts'
      - 'src/**/*.ts'
      - 'scripts/check-schema-drift.ts'

concurrency:
  group: schema-check-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  schema-drift-detection:
    name: Schema Drift Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run schema drift detection
        id: schema-check
        run: |
          npx tsx scripts/check-schema-drift.ts 2>&1 | tee schema-check-output.txt
          exit_code=${PIPESTATUS[0]}
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Create summary for PR comment
          if [ $exit_code -ne 0 ]; then
            echo "has_drift=true" >> $GITHUB_OUTPUT
          else
            echo "has_drift=false" >> $GITHUB_OUTPUT
          fi

          exit $exit_code
        continue-on-error: true

      - name: Generate schema check summary
        if: always()
        run: |
          echo "## Schema Drift Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.schema-check.outputs.has_drift }}" == "true" ]; then
            echo ":x: **Schema drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following schema inconsistencies were found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat schema-check-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### How to fix" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the issues listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Update your type definitions to match canonical types in \`packages/contracts/src/v2/\`" >> $GITHUB_STEP_SUMMARY
            echo "3. See [SCHEMA-GUIDELINES.md](../docs/SCHEMA-GUIDELINES.md) for details" >> $GITHUB_STEP_SUMMARY
          else
            echo ":white_check_mark: **No schema drift detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All type definitions match canonical schemas." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR (drift detected)
        if: github.event_name == 'pull_request' && steps.schema-check.outputs.has_drift == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('schema-check-output.txt', 'utf8');

            // Limit output to prevent huge comments
            const maxLength = 3000;
            const truncatedOutput = output.length > maxLength
              ? output.substring(0, maxLength) + '\n\n... (output truncated)'
              : output;

            const body = `## :warning: Schema Drift Detected

            This PR introduces type definitions that don't match the canonical schemas in \`packages/contracts\`.

            <details>
            <summary>View Details</summary>

            \`\`\`
            ${truncatedOutput}
            \`\`\`

            </details>

            ### How to fix

            1. **Import types from contracts**: Instead of redefining types, import them:
               \`\`\`typescript
               import { TrustBand, DataSensitivity } from '@vorion/contracts';
               \`\`\`

            2. **Match canonical values**: If you must define enums locally, ensure they match exactly.
               See \`packages/contracts/src/v2/enums.ts\` for canonical definitions.

            3. **Check range constraints**: Trust scores must be 0-100, band thresholds must match canonical values.

            4. **Review guidelines**: See [SCHEMA-GUIDELINES.md](../docs/SCHEMA-GUIDELINES.md) for complete documentation.

            ---
            *This comment was generated by the schema drift detection workflow.*`;

            // Check if we already have a comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Schema Drift Detected')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Comment on PR (no drift)
        if: github.event_name == 'pull_request' && steps.schema-check.outputs.has_drift == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we have a previous drift comment to remove/update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Schema Drift Detected')
            );

            if (botComment) {
              // Update the comment to show drift is resolved
              const body = `## :white_check_mark: Schema Drift Resolved

              The schema drift issues from this PR have been resolved. All type definitions now match canonical schemas.

              ---
              *This comment was generated by the schema drift detection workflow.*`;

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            }

      - name: Fail if drift detected
        if: steps.schema-check.outputs.has_drift == 'true'
        run: |
          echo "::error::Schema drift detected. Please fix the issues before merging."
          exit 1

  # Run as part of the main CI if needed
  report-status:
    name: Report Schema Status
    runs-on: ubuntu-latest
    needs: [schema-drift-detection]
    if: always()
    steps:
      - name: Check schema drift result
        run: |
          if [ "${{ needs.schema-drift-detection.result }}" == "failure" ]; then
            echo "Schema drift check failed"
            exit 1
          fi
          echo "Schema drift check passed"
