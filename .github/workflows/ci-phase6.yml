name: Phase 6 Trust Engine CI

on:
  push:
    branches: [master]
    paths:
      - 'packages/aci-*/**'
      - 'apps/agentanchor/lib/**/*phase6*'
      - 'apps/agentanchor/app/api/phase6/**'
      - 'tests/load/phase6-*'
      - '.github/workflows/ci-phase6.yml'
  pull_request:
    branches: [master]
    paths:
      - 'packages/aci-*/**'
      - 'apps/agentanchor/lib/**/*phase6*'
      - 'apps/agentanchor/app/api/phase6/**'
      - 'tests/load/phase6-*'
      - '.github/workflows/ci-phase6.yml'
  schedule:
    # Run nightly at 2am UTC
    - cron: '0 2 * * *'

concurrency:
  group: phase6-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # TypeScript SDK & ACI Client
  # =============================================================================

  build-typescript:
    name: Build TypeScript SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build ACI packages
        run: npx turbo build --filter="@vorion/aci-*"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aci-typescript-dist
          path: packages/aci-*/dist
          retention-days: 1

  test-typescript:
    name: Test TypeScript SDK
    runs-on: ubuntu-latest
    needs: [build-typescript]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: aci-typescript-dist
          path: packages

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ACI tests
        run: npx turbo test --filter="@vorion/aci-*"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: packages/aci-*/coverage/lcov.info
          flags: aci-typescript
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # =============================================================================
  # Python SDK
  # =============================================================================

  lint-python:
    name: Lint Python SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/aci-python
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: packages/aci-python/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Ruff linter
        run: ruff check .
        continue-on-error: true

      - name: Run Black formatter check
        run: black --check .
        continue-on-error: true

  test-python:
    name: Test Python SDK
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/aci-python
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: packages/aci-python/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest --cov=vorion_aci --cov-report=xml --cov-report=html -v
        continue-on-error: true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: packages/aci-python/coverage.xml
          flags: aci-python
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  build-python:
    name: Build Python SDK
    runs-on: ubuntu-latest
    needs: [lint-python, test-python]
    defaults:
      run:
        working-directory: packages/aci-python
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Check package
        run: twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aci-python-dist
          path: packages/aci-python/dist/
          retention-days: 7

  # =============================================================================
  # Phase 6 API Tests
  # =============================================================================

  test-phase6-api:
    name: Test Phase 6 API
    runs-on: ubuntu-latest
    needs: [build-typescript]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: vorion
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: vorion_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: aci-typescript-dist
          path: packages

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run Phase 6 tests
        run: npm test -- --testPathPattern="phase6" --coverage
        working-directory: apps/agentanchor
        env:
          DATABASE_URL: postgres://vorion:testpassword@localhost:5432/vorion_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: apps/agentanchor/coverage/lcov.info
          flags: phase6-api
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  # =============================================================================
  # Security Scan
  # =============================================================================

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python security tools
        run: pip install safety bandit

      - name: Run safety check on Python SDK
        run: |
          cd packages/aci-python
          pip install -e .
          safety check
        continue-on-error: true

      - name: Run bandit security scan
        run: bandit -r packages/aci-python/vorion_aci -ll
        continue-on-error: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # =============================================================================
  # Load Testing (Nightly Only)
  # =============================================================================

  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[load-test]')
    needs: [test-phase6-api]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: vorion
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: vorion_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build app
        run: npx turbo build --filter="./apps/agentanchor"
        env:
          DATABASE_URL: postgres://vorion:testpassword@localhost:5432/vorion_test
          REDIS_URL: redis://localhost:6379

      - name: Start server
        run: |
          cd apps/agentanchor
          npm start &
          sleep 10
        env:
          DATABASE_URL: postgres://vorion:testpassword@localhost:5432/vorion_test
          REDIS_URL: redis://localhost:6379
          PORT: 3000

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Create results directory
        run: mkdir -p tests/load/results

      - name: Run load tests (smoke only for CI)
        run: |
          k6 run tests/load/phase6-load-test.js \
            --env BASE_URL=http://localhost:3000 \
            --out json=tests/load/results/k6-results.json \
            --tag testid=ci-${{ github.run_id }}
        env:
          K6_SCENARIOS: smoke

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: tests/load/results/
          retention-days: 30
        if: always()

  # =============================================================================
  # Integration Test
  # =============================================================================

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [build-typescript, build-python]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: vorion
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: vorion_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download TypeScript artifacts
        uses: actions/download-artifact@v4
        with:
          name: aci-typescript-dist
          path: packages

      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: aci-python-dist
          path: packages/aci-python/dist

      - name: Install Node dependencies
        run: npm ci --legacy-peer-deps

      - name: Install Python SDK
        run: pip install packages/aci-python/dist/*.whl

      - name: Build and start server
        run: |
          npx turbo build --filter="./apps/agentanchor"
          cd apps/agentanchor && npm start &
          sleep 10
        env:
          DATABASE_URL: postgres://vorion:testpassword@localhost:5432/vorion_test
          REDIS_URL: redis://localhost:6379
          PORT: 3000

      - name: Run TypeScript integration tests
        run: |
          cd examples/aci-demo
          npm install
          npm run demo 2>&1 | head -100
        env:
          ACI_BASE_URL: http://localhost:3000
        continue-on-error: true

      - name: Run Python integration tests
        run: |
          python -c "
          import asyncio
          from vorion_aci import ACIClient, TrustTier, AgentRole

          async def test():
              async with ACIClient('http://localhost:3000') as client:
                  stats = await client.get_stats()
                  print(f'Stats retrieved: {stats}')
                  print('Integration test passed!')

          asyncio.run(test())
          "
        continue-on-error: true

  # =============================================================================
  # Success Gate
  # =============================================================================

  phase6-success:
    name: Phase 6 CI Success
    runs-on: ubuntu-latest
    needs: [test-typescript, test-python, test-phase6-api, security-scan]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.test-typescript.result }}" != "success" ]] || \
             [[ "${{ needs.test-python.result }}" != "success" ]] || \
             [[ "${{ needs.test-phase6-api.result }}" != "success" ]]; then
            echo "One or more Phase 6 CI jobs failed"
            exit 1
          fi
          echo "All Phase 6 CI jobs passed!"

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Phase 6 CI Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Phase 6 Trust Engine CI Failed*\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
