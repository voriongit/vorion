name: Release SDKs

on:
  push:
    tags:
      - 'aci-client-v*'
      - 'aci-cli-v*'
      - 'aci-python-v*'
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to release'
        required: true
        type: choice
        options:
          - aci-client
          - aci-cli
          - aci-python
          - all
      version:
        description: 'Version to release (e.g., 1.0.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # Determine what to release
  # =============================================================================

  determine-release:
    name: Determine Release
    runs-on: ubuntu-latest
    outputs:
      release-aci-client: ${{ steps.check.outputs.aci-client }}
      release-aci-cli: ${{ steps.check.outputs.aci-cli }}
      release-aci-python: ${{ steps.check.outputs.aci-python }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Determine packages to release
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PACKAGE="${{ github.event.inputs.package }}"
            VERSION="${{ github.event.inputs.version }}"

            if [[ "$PACKAGE" == "all" ]]; then
              echo "aci-client=true" >> $GITHUB_OUTPUT
              echo "aci-cli=true" >> $GITHUB_OUTPUT
              echo "aci-python=true" >> $GITHUB_OUTPUT
            else
              echo "aci-client=$([[ $PACKAGE == 'aci-client' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "aci-cli=$([[ $PACKAGE == 'aci-cli' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "aci-python=$([[ $PACKAGE == 'aci-python' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            TAG="${GITHUB_REF#refs/tags/}"
            if [[ "$TAG" == aci-client-v* ]]; then
              echo "aci-client=true" >> $GITHUB_OUTPUT
              echo "aci-cli=false" >> $GITHUB_OUTPUT
              echo "aci-python=false" >> $GITHUB_OUTPUT
              echo "version=${TAG#aci-client-v}" >> $GITHUB_OUTPUT
            elif [[ "$TAG" == aci-cli-v* ]]; then
              echo "aci-client=false" >> $GITHUB_OUTPUT
              echo "aci-cli=true" >> $GITHUB_OUTPUT
              echo "aci-python=false" >> $GITHUB_OUTPUT
              echo "version=${TAG#aci-cli-v}" >> $GITHUB_OUTPUT
            elif [[ "$TAG" == aci-python-v* ]]; then
              echo "aci-client=false" >> $GITHUB_OUTPUT
              echo "aci-cli=false" >> $GITHUB_OUTPUT
              echo "aci-python=true" >> $GITHUB_OUTPUT
              echo "version=${TAG#aci-python-v}" >> $GITHUB_OUTPUT
            fi
          fi

  # =============================================================================
  # Release TypeScript SDK (@vorion/aci-client)
  # =============================================================================

  release-aci-client:
    name: Release @vorion/aci-client
    runs-on: ubuntu-latest
    needs: [determine-release]
    if: needs.determine-release.outputs.release-aci-client == 'true'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build package
        run: npx turbo build --filter=@vorion/aci-client

      - name: Run tests
        run: npx turbo test --filter=@vorion/aci-client

      - name: Update version
        if: github.event.inputs.version != ''
        working-directory: packages/aci-client
        run: npm version ${{ needs.determine-release.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/aci-client
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: packages/aci-client
        run: npm publish --dry-run --access public

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          name: "@vorion/aci-client v${{ needs.determine-release.outputs.version }}"
          body: |
            ## @vorion/aci-client v${{ needs.determine-release.outputs.version }}

            ### Installation
            ```bash
            npm install @vorion/aci-client@${{ needs.determine-release.outputs.version }}
            ```

            ### Links
            - [npm](https://www.npmjs.com/package/@vorion/aci-client)
            - [Documentation](https://github.com/voriongit/vorion/tree/main/packages/aci-client)
          generate_release_notes: true

  # =============================================================================
  # Release TypeScript CLI (@vorion/aci-cli)
  # =============================================================================

  release-aci-cli:
    name: Release @vorion/aci-cli
    runs-on: ubuntu-latest
    needs: [determine-release]
    if: needs.determine-release.outputs.release-aci-cli == 'true'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build dependencies
        run: npx turbo build --filter=@vorion/aci-client

      - name: Build CLI
        run: npx turbo build --filter=@vorion/aci-cli

      - name: Run tests
        run: npx turbo test --filter=@vorion/aci-cli

      - name: Update version
        if: github.event.inputs.version != ''
        working-directory: packages/aci-cli
        run: npm version ${{ needs.determine-release.outputs.version }} --no-git-tag-version

      - name: Publish to npm
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/aci-cli
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish (dry run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: packages/aci-cli
        run: npm publish --dry-run --access public

  # =============================================================================
  # Release Python SDK (vorion-aci)
  # =============================================================================

  release-aci-python:
    name: Release vorion-aci (Python)
    runs-on: ubuntu-latest
    needs: [determine-release]
    if: needs.determine-release.outputs.release-aci-python == 'true'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Update version
        if: github.event.inputs.version != ''
        working-directory: packages/aci-python
        run: |
          # Update version in pyproject.toml
          sed -i "s/version = \".*\"/version = \"${{ needs.determine-release.outputs.version }}\"/" pyproject.toml
          # Update version in __init__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"${{ needs.determine-release.outputs.version }}\"/" vorion_aci/__init__.py

      - name: Install package
        working-directory: packages/aci-python
        run: pip install -e ".[dev]"

      - name: Run tests
        working-directory: packages/aci-python
        run: pytest -v
        continue-on-error: true

      - name: Build package
        working-directory: packages/aci-python
        run: python -m build

      - name: Check package
        working-directory: packages/aci-python
        run: twine check dist/*

      - name: Publish to PyPI
        if: github.event.inputs.dry_run != 'true'
        working-directory: packages/aci-python
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

      - name: Publish to PyPI (dry run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: packages/aci-python
        run: |
          echo "Would publish the following files:"
          ls -la dist/

      - name: Create GitHub Release
        if: github.event.inputs.dry_run != 'true' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          name: "vorion-aci v${{ needs.determine-release.outputs.version }}"
          body: |
            ## vorion-aci v${{ needs.determine-release.outputs.version }}

            ### Installation
            ```bash
            pip install vorion-aci==${{ needs.determine-release.outputs.version }}
            ```

            ### Links
            - [PyPI](https://pypi.org/project/vorion-aci/)
            - [Documentation](https://github.com/voriongit/vorion/tree/main/packages/aci-python)
          generate_release_notes: true

  # =============================================================================
  # Post-release notifications
  # =============================================================================

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [determine-release, release-aci-client, release-aci-cli, release-aci-python]
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "SDK Release Complete",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "SDK Release v${{ needs.determine-release.outputs.version }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*@vorion/aci-client:*\n${{ needs.release-aci-client.result == 'success' && '✅ Published' || (needs.release-aci-client.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*@vorion/aci-cli:*\n${{ needs.release-aci-cli.result == 'success' && '✅ Published' || (needs.release-aci-cli.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*vorion-aci (Python):*\n${{ needs.release-aci-python.result == 'success' && '✅ Published' || (needs.release-aci-python.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true
